import express from "express";
import mysql from "mysql2/promise";
import cors from "cors";
import bcrypt from "bcrypt";
import path from "path";
import { fileURLToPath } from "url";
import crypto from "crypto";

/* ================================
   CONFIGURAÃ‡ÃƒO PATH
================================ */
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();

/* ================================
   MIDDLEWARES
================================ */
app.use(cors());
app.use(express.json({ limit: "10mb" }));

/* ================================
   CONEXÃƒO COM MYSQL (RAILWAY SAFE)
================================ */
let pool;
try {
  if (process.env.DATABASE_URL) {
    console.log("ðŸŒ Railway DATABASE_URL detectada");
    const dbUrl = new URL(process.env.DATABASE_URL);
    pool = mysql.createPool({
      host: dbUrl.hostname,
      user: decodeURIComponent(dbUrl.username),
      password: decodeURIComponent(dbUrl.password),
      database: dbUrl.pathname.replace("/", ""),
      port: Number(dbUrl.port) || 3306,
      ssl: { rejectUnauthorized: false },
      waitForConnections: true,
      connectionLimit: 10,
    });
  } else {
    console.log("ðŸ’» Usando variÃ¡veis DB_*");
    pool = mysql.createPool({
      host: process.env.DB_HOST || "localhost",
      user: process.env.DB_USER || "root",
      password: process.env.DB_PASSWORD || "",
      database: process.env.DB_NAME || "",
      port: Number(process.env.DB_PORT) || 3306,
      waitForConnections: true,
      connectionLimit: 10,
    });
  }
} catch (err) {
  console.error("âŒ ERRO AO CONFIGURAR BANCO:", err);
}

/* ================================
   TESTE DE CONEXÃƒO AUTOMÃTICO
================================ */
(async () => {
  try {
    const conn = await pool.getConnection();
    console.log("âœ… MYSQL CONECTADO COM SUCESSO!");
    conn.release();
  } catch (err) {
    console.error("âŒ ERRO AO CONECTAR NO MYSQL:", err.message);
  }
})();

/* ================================
   ROTAS API
================================ */
app.get("/api/ping", (req, res) => res.json({ ok: true }));

app.post("/api/registrar", async (req, res) => {
  const { nome, email, senha, foto, tipo_usuario } = req.body;
  if (!nome || !email || !senha || !tipo_usuario)
    return res.status(400).json({ success: false, error: "Campos obrigatÃ³rios faltando." });

  try {
    const [rows] = await pool.query("SELECT id FROM usuarios WHERE email = ?", [email]);
    if (rows.length) return res.status(400).json({ success: false, error: "Email jÃ¡ registrado." });

    const hash = await bcrypt.hash(senha, 10);
    const token = crypto.randomBytes(32).toString("hex");

    await pool.query(`
      INSERT INTO usuarios
      (nome, email, senha, foto, pontos, online, tipo_usuario, confirmado, token_confirmacao)
      VALUES (?, ?, ?, ?, 0, FALSE, ?, FALSE, ?)
    `, [nome, email, hash, foto || null, tipo_usuario, token]);

    res.json({ success: true, message: "Conta criada. Confirme por e-mail." });
  } catch (err) {
    console.error("âŒ REGISTRO:", err.message);
    res.status(500).json({ success: false, error: "Erro interno" });
  }
});

app.post("/api/login", async (req, res) => {
  const { email, senha } = req.body;
  try {
    const [rows] = await pool.query(`
      SELECT id, nome, email, senha, foto, pontos, confirmado, tipo_usuario
      FROM usuarios
      WHERE email = ?
    `, [email]);

    if (!rows.length) return res.status(400).json({ success: false, error: "Credenciais invÃ¡lidas" });

    const usuario = rows[0];
    const ok = await bcrypt.compare(senha, usuario.senha);
    if (!ok) return res.status(400).json({ success: false, error: "Credenciais invÃ¡lidas" });

    if (!usuario.confirmado) return res.status(403).json({ success: false, error: "Email nÃ£o confirmado" });

    delete usuario.senha;
    res.json({ success: true, usuario });
  } catch (err) {
    console.error("âŒ LOGIN:", err.message);
    res.status(500).json({ success: false, error: "Erro interno" });
  }
});

// Outras rotas de API (desafios, confirmar, etc.) aqui
// ...

/* ================================
   SERVIR FRONTEND
   - Servir apenas a pasta frontend
================================ */
app.use(express.static(path.join(__dirname, "frontend")));

/* ================================
   INICIAR SERVIDOR
================================ */
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log("ðŸš€ Servidor rodando na porta", PORT));
